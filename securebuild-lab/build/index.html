


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.4.0">
    
    
      
        <title>Securely Build your Application - Hyper Protect Virtual Servers (HPVS) Workshop</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fe0cca5b.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#securely-build-your-application" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="../.." title="Hyper Protect Virtual Servers (HPVS) Workshop" class="md-header-nav__button md-logo" aria-label="Hyper Protect Virtual Servers (HPVS) Workshop">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Hyper Protect Virtual Servers (HPVS) Workshop
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Securely Build your Application
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/ibm-wsc/hyper-protect-virtual-servers-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Hyper Protect Virtual Servers (HPVS) Workshop" class="md-nav__button md-logo" aria-label="Hyper Protect Virtual Servers (HPVS) Workshop">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Hyper Protect Virtual Servers (HPVS) Workshop
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/ibm-wsc/hyper-protect-virtual-servers-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../prerequisites/" title="Prerequisites" class="md-nav__link">
      Prerequisites
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../assignment/" title="Assignments" class="md-nav__link">
      Assignments
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Secure Image Build Lab
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Secure Image Build Lab" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Secure Image Build Lab
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Hyper Protect Virtual Servers (HPVS) Lab Process Overview" class="md-nav__link">
      Hyper Protect Virtual Servers (HPVS) Lab Process Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../securebuild-setup/" title="Configuring your Environment" class="md-nav__link">
      Configuring your Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../create-server/" title="Create your HPVS Secure Build Server" class="md-nav__link">
      Create your HPVS Secure Build Server
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Securely Build your Application
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Securely Build your Application" class="md-nav__link md-nav__link--active">
      Securely Build your Application
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#export-variables-set-in-previous-sections-to-current-terminal-session" class="md-nav__link">
    Export Variables set in previous sections to current terminal session
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-repository-registration-gpg-signing-key" class="md-nav__link">
    Create repository registration GPG signing key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-build-configuration" class="md-nav__link">
    Set Build Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-application" class="md-nav__link">
    Build Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting-secure-build" class="md-nav__link">
    Troubleshooting Secure Build
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-your-application" class="md-nav__link">
    Verify your application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deploy-app/" title="Deploy your Securely Built Application as a Hyper Protect Virtual Server" class="md-nav__link">
      Deploy your Securely Built Application as a Hyper Protect Virtual Server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bitcoin_wallet/" title="Welcome to the Secure Bitcoin Wallet on IBM LinuxONE" class="md-nav__link">
      Welcome to the Secure Bitcoin Wallet on IBM LinuxONE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cleanup/" title="Clean up your Environment" class="md-nav__link">
      Clean up your Environment
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../grep11-lab/assignments/" title="GREP11 Lab virtual machine assignments" class="md-nav__link">
      GREP11 Lab virtual machine assignments
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      GREP11 Lab
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="GREP11 Lab" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        GREP11 Lab
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/overview/" title="Lab overview" class="md-nav__link">
      Lab overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/grep11-setup/" title="How to set up a GREP11 server" class="md-nav__link">
      How to set up a GREP11 server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/grep11-display/" title="Displaying your GREP11 environment" class="md-nav__link">
      Displaying your GREP11 environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/run-grep11-samples/" title="Run the GREP11 sample code" class="md-nav__link">
      Run the GREP11 sample code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6-5" type="checkbox" id="nav-6-5">
    
    <label class="md-nav__link" for="nav-6-5">
      Run the Lab exercises
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Run the Lab exercises" data-md-level="2">
      <label class="md-nav__title" for="nav-6-5">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Run the Lab exercises
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/exercise-overview/" title="An overview of the Exercises" class="md-nav__link">
      An overview of the Exercises
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/lab-exercise1/" title="Exercise 1 (List PKCS Mechanisms)" class="md-nav__link">
      Exercise 1 (List PKCS Mechanisms)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/lab-exercise2/" title="Exercise 2 (Encryption and Decryption)" class="md-nav__link">
      Exercise 2 (Encryption and Decryption)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/lab-exercise3/" title="Exercise 3 (Sign and Verify)" class="md-nav__link">
      Exercise 3 (Sign and Verify)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../grep11-lab/lab-exercise4/" title="Exercise 4 (Wrap and Unwrap Key)" class="md-nav__link">
      Exercise 4 (Wrap and Unwrap Key)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../glossary/" title="Glossary of terms" class="md-nav__link">
      Glossary of terms
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../resources/" title="Other resources" class="md-nav__link">
      Other resources
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../proposechange/" title="Propose a change" class="md-nav__link">
      Propose a change
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#export-variables-set-in-previous-sections-to-current-terminal-session" class="md-nav__link">
    Export Variables set in previous sections to current terminal session
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-repository-registration-gpg-signing-key" class="md-nav__link">
    Create repository registration GPG signing key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-build-configuration" class="md-nav__link">
    Set Build Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build-application" class="md-nav__link">
    Build Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting-secure-build" class="md-nav__link">
    Troubleshooting Secure Build
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verify-your-application" class="md-nav__link">
    Verify your application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-wsc/hyper-protect-virtual-servers-workshop/edit/master/docs/securebuild-lab/build.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="securely-build-your-application">Securely Build your Application<a class="headerlink" href="#securely-build-your-application" title="Permanent link">&para;</a></h1>
<h2 id="export-variables-set-in-previous-sections-to-current-terminal-session">Export Variables set in previous sections to current terminal session<a class="headerlink" href="#export-variables-set-in-previous-sections-to-current-terminal-session" title="Permanent link">&para;</a></h2>
<p>Source <code>bashrc</code> to set necessary variables if unset</p>
<div class="highlight"><pre><span></span><code><span class="nb">source</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.bashrc&quot;</span>
</code></pre></div>

<h2 id="create-repository-registration-gpg-signing-key">Create repository registration GPG signing key<a class="headerlink" href="#create-repository-registration-gpg-signing-key" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Set key name</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">keyName</span><span class="o">=</span><span class="s2">&quot;secure_bitcoin_key</span><span class="si">${</span><span class="nv">RANDOM</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p><code>${RANDOM}</code> stores a pseudo-random number to use since GPG keys on a system must each have a unique key name (uid). This will make sure users can safely re-run commands for multiple runs if they so choose.</p>
</div>
</li>
<li>
<p>Set key passphrase</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">Command Syntax</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">passphrase</span><span class="o">=</span><span class="s2">&quot;your_passphrase&quot;</span>
</code></pre></div>

</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Example Command</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">passphrase</span><span class="o">=</span><span class="s2">&quot;most_secure_pw_i_could_think_of&quot;</span>
</code></pre></div>

</div>
</div>
</li>
<li>
<p>Create directory to store Docker repository registration signing key material</p>
<div class="highlight"><pre><span></span><code>mkdir -p <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/registration_keys&quot;</span>
</code></pre></div>

</li>
<li>
<p>Create Key Definition</p>
<div class="highlight"><pre><span></span><code>cat &gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/registration_keys/</span><span class="si">${</span><span class="nv">keyName</span><span class="si">}</span><span class="s2">_definition_keys&quot;</span> <span class="s">&lt;&lt;EOF</span>
<span class="s">%echo Generating registration definition key</span>
<span class="s">Key-Type: RSA</span>
<span class="s">Key-Length: 4096</span>
<span class="s">Subkey-Type: RSA</span>
<span class="s">Subkey-Length: 4096</span>
<span class="s">Name-Real: ${keyName}</span>
<span class="s">Expire-Date: 0</span>
<span class="s">Passphrase: ${passphrase}</span>
<span class="s"># Do a commit here, so that we can later print &quot;done&quot; :-)</span>
<span class="s">%commit</span>
<span class="s">%echo done</span>
<span class="s">EOF</span>
</code></pre></div>

</li>
<li>
<p>Generate Key pair</p>
<div class="highlight"><pre><span></span><code>gpg --armor --batch <span class="se">\</span>
--generate-key <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/registration_keys/</span><span class="si">${</span><span class="nv">keyName</span><span class="si">}</span><span class="s2">_definition_keys&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>gpg: directory <span class="s1">&#39;/home/multiarch-lab/.gnupg&#39;</span> created
gpg: keybox <span class="s1">&#39;/home/multiarch-lab/.gnupg/pubring.kbx&#39;</span> created
gpg: Generating registration definition key
gpg: /home/multiarch-lab/.gnupg/trustdb.gpg: trustdb created
gpg: key 7E05CE05DFEBA2BC marked as ultimately trusted
gpg: directory <span class="s1">&#39;/home/multiarch-lab/.gnupg/openpgp-revocs.d&#39;</span> created
gpg: revocation certificate stored as <span class="s1">&#39;/home/multiarch-lab/.gnupg/openpgp-revocs.d/27FB55DC5F7FDF0598C9B1007E05CE05DFEBA2BC.rev&#39;</span>
gpg: <span class="k">done</span>
</code></pre></div>

</details>
</li>
<li>
<p>Export Private key</p>
<div class="highlight"><pre><span></span><code>gpg --armor --pinentry-mode<span class="o">=</span>loopback --passphrase  <span class="s2">&quot;</span><span class="si">${</span><span class="nv">passphrase</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
--export-secret-keys <span class="s2">&quot;</span><span class="si">${</span><span class="nv">keyName</span><span class="si">}</span><span class="s2">&quot;</span> &gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/registration_keys/</span><span class="si">${</span><span class="nv">keyName</span><span class="si">}</span><span class="s2">.private&quot;</span>
</code></pre></div>

</li>
<li>
<p>Export Public key</p>
<div class="highlight"><pre><span></span><code>gpg --armor --export <span class="si">${</span><span class="nv">keyName</span><span class="si">}</span> &gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/registration_keys/</span><span class="si">${</span><span class="nv">keyName</span><span class="si">}</span><span class="s2">.pub&quot;</span>
</code></pre></div>

</li>
<li>
<p>List newly generated key files </p>
<div class="highlight"><pre><span></span><code> ls <span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span>/registration_keys/
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>secure_bitcoin_key_definition_keys  secure_bitcoin_key.pub secure_bitcoin_key.private
</code></pre></div>

</details>
</li>
</ol>
<h2 id="set-build-configuration">Set Build Configuration<a class="headerlink" href="#set-build-configuration" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Set Secure Build Lab IP Address</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">SB_IP</span><span class="o">=</span><span class="m">192</span>.168.22.80
</code></pre></div>

</li>
<li>
<p>Save Secure Build Lab IP Address for later use</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;export SB_IP=&#39;</span><span class="si">${</span><span class="nv">SB_IP</span><span class="si">}</span><span class="s2">&#39;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.bashrc&quot;</span>
</code></pre></div>

</li>
<li>
<p>Set Secure Build GitHub repository</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">GH_REPO</span><span class="o">=</span><span class="s2">&quot;git@github.com:IBM/secure-bitcoin-wallet.git&quot;</span>
</code></pre></div>

</li>
<li>
<p>Set Docker Image Name</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">IMAGE_NAME</span><span class="o">=</span><span class="s2">&quot;hpvs_bc&quot;</span>
</code></pre></div>

</li>
<li>
<p>Set repository registration name</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">REPO_ID</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">IMAGE_NAME</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">HPVS_NUMBER</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

</li>
<li>
<p>Save repository registration name for later use</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;export REPO_ID=&#39;</span><span class="si">${</span><span class="nv">REPO_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span> &gt;&gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">HOME</span><span class="si">}</span><span class="s2">/.bashrc&quot;</span>
</code></pre></div>

</li>
<li>
<p>Create config file</p>
<p><div class="highlight"><pre><span></span><code>cat &gt; &quot;${SB_DIR}/sb_config.yaml&quot; &lt;&lt;EOF
secure_build_workers:
    sbs:
        url: &#39;https://${SB_IP}&#39;
        port: &#39;${SB_PORT}&#39;
        cert_path: &#39;${SB_DIR}/sbs_keys/sbs.cert&#39;
        key_path: &#39;${SB_DIR}/sbs_keys/sbs.key&#39;
    regfile:
        id: &#39;${REPO_ID}&#39;
    github:
        url: &#39;${GH_REPO}&#39;
        branch: &#39;master&#39;
        ssh_private_key_path: &#39;${GITHUB_SSH_KEY}&#39;
        recurse_submodules: &#39;False&#39;
        dockerfile_path: &#39;./Dockerfile&#39;
        docker_build_path: &#39;./&#39;
    docker:
        push_server: &#39;${REGISTRY_NAME}&#39;
        #base_server: &#39;${REGISTRY_NAME}&#39;
        pull_server: &#39;${REGISTRY_NAME}&#39;
        repo: &#39;${DOCKER_USERNAME}/${IMAGE_NAME}&#39;
        image_tag_prefix: &#39;latest&#39;
        content_trust_base: &#39;False&#39;
    env:
        whitelist: []
    build:
        args: []
    signing_key:
        private_key_path: &#39;${SB_DIR}/registration_keys/${keyName}.private&#39;
        public_key_path: &#39;${SB_DIR}/registration_keys/${keyName}.pub&#39;
EOF
</code></pre></div>
8. Continue to the <a href="#build-application">Build Application section</a> if you are launching secure build for the first time or the <a href="#troubleshooting-secure-build">Troubleshooting Secure Build section</a> if things didn't go as planned your first go-round and you are trying to get back on the right track.</p>
</li>
</ol>
<h2 id="build-application">Build Application<a class="headerlink" href="#build-application" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Initialize Secure Build Hyper Protect Virtual server with configuration file generated in the <a href="#set-build-configuration">Set Build Configuration section</a></p>
<div class="highlight"><pre><span></span><code>hpvs sb init --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div>

<div class="admonition example">
<p class="admonition-title">Example Output</p>
<div class="highlight"><pre><span></span><code><span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;OK&quot;</span><span class="o">}</span>
</code></pre></div>

</div>
</li>
<li>
<p>Launch secure build with a timeout of 20 minutes (1200 seconds) to complete using the configuration file generated in the <a href="#set-build-configuration">Set Build Configuration section</a></p>
<div class="highlight"><pre><span></span><code>hpvs sb build <span class="se">\</span>
--timeout <span class="m">1200</span> <span class="se">\</span>
--config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The following build will take anywhere from <strong>15-20 minutes</strong> to complete. While this is ongoing, you should open a new tab in your terminal to check the automatically updating logs and build status (steps for doing this are detailed in the next few steps). If this command times out please check the status in the <code>step 3</code> to make sure nothing went wrong. It might just be that your build took to long and everything will be ok. If something did go wrong, visit the <a href="#troubleshooting-secure-build">Troubleshooting Secure Build section</a></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The secure build is asynchronous so if the command gets interrupted here don't worry! <img alt="😁" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f601.svg" title=":grin:" /></p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the secure build command gets an error this command will keep on waiting until eventually timing out. If you see an error in the <code>status</code> you can interrupt this command with <code>ctrl+c</code> instead of waiting for it to time out. </p>
</div>
<details class="example" open="open"><summary>Example Output after running 15-20 minutes to completion</summary><div class="highlight"><pre><span></span><code>+--------+-------------------------+
<span class="p">|</span> status <span class="p">|</span> OK: async build started <span class="p">|</span>
+--------+-------------------------+
<span class="c1">##############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################</span>
+---------------------+--------------------------------------------------------------------------------------------+
<span class="p">|</span> root_ssh_enabled    <span class="p">|</span> <span class="nb">false</span>                                                                                      <span class="p">|</span>
<span class="p">|</span> status              <span class="p">|</span> success                                                                                    <span class="p">|</span>
<span class="p">|</span> build_name          <span class="p">|</span> docker.io.gmoney23.hpvs_bc_a.latest-b3416d8.2020-06-23_22-12-54.183641                     <span class="p">|</span>
<span class="p">|</span> image_tag           <span class="p">|</span> latest-b3416d8                                                                             <span class="p">|</span>
<span class="p">|</span> manifest_key_gen    <span class="p">|</span> soft_crypto                                                                                <span class="p">|</span>
<span class="p">|</span> manifest_public_key <span class="p">|</span> manifest.docker.io.gmoney23.hpvs_bc_a.latest-b3416d8.2020-06-23_22-12-54.183641-public.pem <span class="p">|</span>
+---------------------+--------------------------------------------------------------------------------------------+
</code></pre></div>

</details>
</li>
<li>
<p>Please look at the logs in another terminal window while the secure build is running (don't interrupt the current terminal window which is waiting for the secure build) </p>
<div class="highlight"><pre><span></span><code>hpvs sb log --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Truncated Output</summary><div class="highlight"><pre><span></span><code>2020-06-23 05:25:42,453  root       INFO    starting a build
2020-06-23 05:25:42,454  root       INFO    cleaning up the local github repo and the github access credential
2020-06-23 05:25:42,454  root       INFO    github_dir=secure-bitcoin-wallet
2020-06-23 05:25:42,454  root       INFO    cloning a github repo
2020-06-23 05:25:42,454  root       INFO    github_host=github.com
2020-06-23 05:25:42,454  root       INFO    cmd=ssh-keyscan github.com
2020-06-23 05:25:47,659  root       INFO    # github.com:22 SSH-2.0-babeld-7c96ae41
# github.com:22 SSH-2.0-babeld-b6072416
# github.com:22 SSH-2.0-babeld-b6072416
github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pL
.....
</code></pre></div>

</details>
</li>
<li>
<p>You can also look at the secure build status in another window. This can be useful if you accidentally interrupted the secure build command or it times out due to the timeout not being long enough. It will also fill out the additional fields that are initially blank when the build completes (such as <code>build_name</code> and <code>manifest_public_key</code>, etc.).</p>
<div class="highlight"><pre><span></span><code>hpvs sb status --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>+---------------------+---------------+
<span class="p">|</span> manifest_public_key <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span> root_ssh_enabled    <span class="p">|</span> <span class="nb">false</span>         <span class="p">|</span>
<span class="p">|</span> status              <span class="p">|</span> github cloned <span class="p">|</span>
<span class="p">|</span> build_name          <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span> image_tag           <span class="p">|</span>               <span class="p">|</span>
<span class="p">|</span> manifest_key_gen    <span class="p">|</span>               <span class="p">|</span>
+---------------------+---------------+
</code></pre></div>

</details>
<div class="admonition error">
<p class="admonition-title">If you see an error in your status</p>
<p>If you see that your build ran into an error please visit the <a href="#troubleshooting-secure-build">Troubleshooting Secure Build section</a></p>
</div>
</li>
<li>
<p>You can continue to check the logs to monitor the progress of your secure build with the previous logs command</p>
<div class="highlight"><pre><span></span><code>hpvs sb log --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div>

</li>
<li>
<p>When the secure build successfully completes, it will have ending logs similar to the following:</p>
<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code><span class="m">2020</span>-06-23 <span class="m">08</span>:39:46,463  root       INFO    run: latest: digest: sha256:ffbaf396807659d5a4d66fe54c0ebf382a9f170c4eaf187b9b4c8582ca8fdec2 size: <span class="m">5133</span>
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:46,463  root       INFO    run: Signing and pushing trust metadata
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,299  root       INFO    run: Successfully signed docker.io/gmoney23/hpvs_bc:latest
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,300  root       INFO    run: <span class="k">return</span> <span class="nv">code</span> <span class="o">=</span> <span class="m">0</span>
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,300  root       INFO    extracting an image keyid and key
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,301  root       INFO    <span class="nv">keyid</span><span class="o">=</span>0cc264a565c452ea6aca776b2787be54e94b905113e77edae00d5ec267a07ffc
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,301  root       INFO    <span class="nv">publickey</span><span class="o">=</span>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJmVENDQVNTZ0F3SUJBZ0lSQUt3cTlRWEZhMzRYMXdIRmZST2NJZXN3Q2dZSUtvWkl6ajBFQXdJd0pURWoKTUNFR0ExVUVBd3dhWkc5amEyVnlMbWx2TDJkdGIyNWxlVEl6TDJod2RuTmZZbU13SGhjTk1qQXdOakl6TURnegpPVFF4V2hjTk16QXdOakl4TURnek9UUXhXakFsTVNNd0lRWURWUVFEREJwa2IyTnJaWEl1YVc4dloyMXZibVY1Ck1qTXZhSEIyYzE5aVl6QlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJKU3ZPdWlSaHJNcjJmQVYKcmZLcHZncVRYNXZwSFlodnEvZXc1SFRuMzRMcnBrQ0xJMjBkdmxjcTUyc1ZvQjVxYkpzeEdTbkphOU5sM0tYYQpZUlRjQ2Z1ak5UQXpNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBekFNCkJnTlZIUk1CQWY4RUFqQUFNQW9HQ0NxR1NNNDlCQU1DQTBjQU1FUUNJRlhFWE9iZTdHR1NsSjEzTzZicTR6T0IKamhoMlZSbmRYOVJYMytrSFpnVVVBaUJBWXAyNTkwTkpVelJIK1lhR2JzQ1hMRmxOUWRzT2ltWW9NMzlqR0IwRAp5dz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,301  root       INFO    generating a config file
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,301  root       INFO    create_and_push: SoftCrypto
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,819  root       INFO    <span class="nv">digest</span><span class="o">=</span>1f0b1f65b1462f16930b200c77ce5fbe654e1d624405bc243d713de1aade36b7
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,819  root       INFO    <span class="nv">block_size</span><span class="o">=</span><span class="m">64</span>
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,821  root       INFO    <span class="nv">digest</span><span class="o">=</span>1f0b1f65b1462f16930b200c77ce5fbe654e1d624405bc243d713de1aade36b7
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,824  root       INFO    <span class="nv">signature</span><span class="o">=</span>114157a8bd98d7f5a5c2ca33f81496563af7f18d23123fc35c8aa84a5bfadc709ecb17e5e79d42d6bd6ac8a815053d9cfd039b7f01ab84b9a75a23e2917b0bc4f0c1b5bd5664dfebd573c2355c34115762b8fea56285d65cd8db4877c9b95ab3149b65d14ce1a23b1065a34c2d4ba9a1526286a03d87d307a5972cf1425e586c9d213b34fe53407c79a527e78779b7a70b426516db35f22a09329dfac76a8505613249ad2b46070ad7d932a8c4bbe1981d0370150528cb9e6f5a426be6734405435393a8d6d8e145418398f85bc28be6c332d2fa2e84f5465618051b110a3efcd25600dc95ee0d7f8bc0d36b8ddaa9ce1c4be78f38928d9213e5171078e22930
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:48,824  root       INFO    <span class="nv">verify</span><span class="o">=</span>OK
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:49,214  root       WARNING undefined MANIFEST_BUCKET_NAME
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:49,214  root       WARNING skipping transferring a manifest to COS
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:49,214  root       INFO    cleaning up the build environment
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:49,214  root       INFO    <span class="nv">github_dir</span><span class="o">=</span>secure-bitcoin-wallet
<span class="m">2020</span>-06-23 <span class="m">08</span>:39:49,217  root       INFO    completed a build
</code></pre></div>

</details>
</li>
<li>
<p>When the secure build successfully completes, you can check the status again to see a <code>completed</code> status.</p>
<div class="highlight"><pre><span></span><code>hpvs sb status --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>+---------------------+------------------------------------------------------------------------------------------+
<span class="p">|</span> build_name          <span class="p">|</span> docker.io.gmoney23.hpvs_bc.latest-b3416d8.2020-06-23_08-39-48.301849                     <span class="p">|</span>
<span class="p">|</span> image_tag           <span class="p">|</span> latest-b3416d8                                                                           <span class="p">|</span>
<span class="p">|</span> manifest_key_gen    <span class="p">|</span> soft_crypto                                                                              <span class="p">|</span>
<span class="p">|</span> manifest_public_key <span class="p">|</span> manifest.docker.io.gmoney23.hpvs_bc.latest-b3416d8.2020-06-23_08-39-48.301849-public.pem <span class="p">|</span>
<span class="p">|</span> root_ssh_enabled    <span class="p">|</span> <span class="nb">false</span>                                                                                    <span class="p">|</span>
<span class="p">|</span> status              <span class="p">|</span> success                                                                                  <span class="p">|</span>
+---------------------+------------------------------------------------------------------------------------------+
</code></pre></div>

</details>
<div class="admonition error">
<p class="admonition-title">If you see an error in your status</p>
<p>If you see that your build ran into an error please visit the <a href="#troubleshooting-secure-build">Troubleshooting Secure Build section</a></p>
</div>
</li>
<li>
<p>From the original terminal window that you ran <code>hpvs sb init</code>, output the repository registration file.</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">passphrase</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> hpvs sb regfile <span class="se">\</span>
--config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span> <span class="se">\</span>
--out <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/yaml.</span><span class="si">${</span><span class="nv">REPO_ID</span><span class="si">}</span><span class="s2">.enc&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>Enter Sigining Private key passphrase:
</code></pre></div>

</details>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>echo</code> command takes care of the passphrase so you don't need to enter it manually.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you run this command from a terminal window where you did not set the <code>passphrase</code> environment variable you will get an error saying <code>openpgp: invalid data: private key checksum failure</code>. You can also check to make sure you are in the right terminal window by running <code>echo "${passphrase}"</code> and the output should be the passphrase you set in the beginning of the "Create repository registration GPG signing key" section. </p>
</div>
</li>
</ol>
<h2 id="troubleshooting-secure-build">Troubleshooting Secure Build<a class="headerlink" href="#troubleshooting-secure-build" title="Permanent link">&para;</a></h2>
<details open="open"><summary>Troubleshooting Instructions</summary><p>If your build completed successfully, feel free to <a href="#verify-your-application">SKIP this section</a> <img alt="😄" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f604.svg" title=":smile:" /></p>
<div class="admonition error">
<p class="admonition-title">If your build failed continue for instructions on how to find the happy path yet again.</p>
<p>If at any point you see an error in the status command you will need to restart your build with the following steps.</p>
<ol>
<li>If the secure build command is still running in its own window please interrupt it with <code>ctrl + c</code></li>
<li>Check the logs for more error information using:
    <div class="highlight"><pre><span></span><code>hpvs sb log --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div></li>
<li>Correct whatever information was incorrect and go back through the steps in the <a href="#set-build-configuration">Set Build Configuration section</a></li>
<li>Clean up the data (i.e. logs) from the old build with:
    <div class="highlight"><pre><span></span><code>hpvs sb clean --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div></li>
<li>Update the secure build server with the new configuration
    <div class="highlight"><pre><span></span><code>hpvs sb update --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span>
</code></pre></div></li>
<li>Continue onward like you just initialized your build server (You did ... just for another time <img alt="😁" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f601.svg" title=":grin:" />) at <code>Step 2</code> in the <a href="#build-application">Build Application Section</a></li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The next command you should run will be <code>hpvs sb build</code> (<code>Step 2</code> in the <a href="#build-application">Build Application Section</a>)</p>
</div>
</div>
</details>
<h2 id="verify-your-application">Verify your application<a class="headerlink" href="#verify-your-application" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Create directories for your manifest file information and change into your new <code>manifest</code> directory.</p>
<div class="highlight"><pre><span></span><code>mkdir -p <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/manifest/manifest_files&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/manifest&quot;</span>
</code></pre></div>

</li>
<li>
<p>Save the build name from the status command as a variable</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">BUILD_NAME</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>hpvs sb status --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span> <span class="se">\</span>
<span class="p">|</span> grep build_name <span class="p">|</span> egrep -ow <span class="s1">&#39;docker.*[[:digit:]]&#39;</span><span class="k">)</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>docker.io.gmoney23.hpvs_bc.latest-b3416d8.2020-06-23_08-39-48.301849
</code></pre></div>

</details>
</li>
<li>
<p>Get your application manifest</p>
<div class="highlight"><pre><span></span><code>hpvs sb manifest --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span> --name <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

</li>
<li>
<p>Get your manifest public verification key</p>
<div class="highlight"><pre><span></span><code>hpvs sb pubkey --config <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/sb_config.yaml&quot;</span> --name <span class="s2">&quot;</span><span class="si">${</span><span class="nv">BUILD_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Connections to the secure build server are secured using mutual tls. This means that proper certificates and keys have to be used on the client side to access these files (as well as when doing the previous secure build commands). This adds a layer of security to make sure that the <code>public key</code> and <code>manifest files</code> are authentic and securely distributed.</p>
</div>
</li>
<li>
<p>Check that your application manifest and signing key were retrieved</p>
<div class="highlight"><pre><span></span><code>ls
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>docker.io.gmoney23.hpvs_bc_a.latest-b3416d8.2020-06-23_22-12-54.183641-public.pem
manifest.docker.io.gmoney23.hpvs_bc_a.latest-b3416d8.2020-06-23_22-12-54.183641.sig.tbz
manifest_files
</code></pre></div>

</details>
</li>
<li>
<p>Set <code>MANIFEST</code> to point to your manifest files.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">MANIFEST</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/manifest/manifest.</span><span class="si">${</span><span class="nv">BUILD_NAME</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

</li>
<li>
<p>Set <code>MAN_PUBKEY</code> to point to your manifest public key.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">MAN_PUBKEY</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/manifest/</span><span class="si">${</span><span class="nv">BUILD_NAME</span><span class="si">}</span><span class="s2">-public.pem&quot;</span>
</code></pre></div>

</li>
<li>
<p>Untar and unzip the manifest <code>.sig.tbz</code> file to reveal the <code>.sig</code> and <code>.tbz</code> files (and remove the original <code>.sig.tbz</code>)</p>
<div class="highlight"><pre><span></span><code>tar -xjvf <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.sig.tbz&quot;</span> <span class="o">&amp;&amp;</span> rm <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.sig.tbz&quot;</span>
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>manifest.docker.io.gmoney23.hpvs_bc_a.latest-b3416d8.2020-06-23_22-12-54.183641.tbz
manifest.docker.io.gmoney23.hpvs_bc_a.latest-b3416d8.2020-06-23_22-12-54.183641.sig
</code></pre></div>

</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>.sig.tbz</code> was a tarball compressed using bzip2 compression of both a nested <code>.tbz</code> file (containing the manifest files) and a <code>.sig</code> file containing a signature of the nested <code>.tbz</code> to verify it with the public key retrieved using the <code>hpvs sb pubkey</code> command above saved in the file referenced by <code>MAN_PUBKEY</code>.</p>
</div>
</li>
<li>
<p>Convert the signature file to binary format</p>
<div class="highlight"><pre><span></span><code>cat <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.sig&quot;</span> <span class="p">|</span> xxd -r -p &gt; <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.sig.bin&quot;</span>
</code></pre></div>

</li>
<li>
<p>Hash (<code>SHA256</code>) the manifest <code>.tbz</code> file (containing the manifest files)</p>
<div class="highlight"><pre><span></span><code>openssl dgst -sha256 -binary -out <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.tbz.sha256&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.tbz&quot;</span>
</code></pre></div>

</li>
<li>
<p>Verify that the <code>.tbz</code> manifest package was the one signed on the secure build server.</p>
<div class="highlight"><pre><span></span><code>openssl dgst -sha256 -verify <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MAN_PUBKEY</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
-signature <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.sig.bin&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.tbz.sha256&quot;</span>
</code></pre></div>

<details class="success" open="open"><summary>Success</summary><div class="highlight"><pre><span></span><code>Verified OK
</code></pre></div>

</details>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>On the secure build server, the <code>.tbz</code> manifest file was hashed and then signed by the manifest private key which only exists on the server (inside its secure environment). Here, you are using the matching public key you received from the secure build server (using a mutual tls connection) in <code>step 4</code> to "undo" this signature to reveal the original hash of the file. We then compare this hash to the hash of the file we have using the above <code>verify</code> command. <code>Verification OK</code> means they are the same, implying that the <code>.tbz</code> file we have now was the same one that was signed by the manifest private key inside the safe confines of the secure build server.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this case, we are double hashing the <code>.tbz</code> file on the signature side which is why we hash the <code>.tbz</code> before the verify command here.</p>
</div>
</li>
<li>
<p>Untar and unzip the manifest <code>.tbz</code> file into the <code>manifest_files</code> directory.</p>
<div class="highlight"><pre><span></span><code>tar -xjf <span class="s2">&quot;</span><span class="si">${</span><span class="nv">MANIFEST</span><span class="si">}</span><span class="s2">.tbz&quot;</span> -C <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/manifest/manifest_files&quot;</span>
</code></pre></div>

</li>
<li>
<p>Change into the <code>manifest_files</code> directory with your manifest files and view the files in the directory.</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">SB_DIR</span><span class="si">}</span><span class="s2">/manifest/manifest_files&quot;</span> <span class="o">&amp;&amp;</span> ls
</code></pre></div>

<details class="example" open="open"><summary>Example Output</summary><div class="highlight"><pre><span></span><code>data  git  root_ssh
</code></pre></div>

</details>
<div class="admonition info">
<p class="admonition-title">Manifest explanation</p>
<p>This <code>manifest</code> package contains three directories as shown above. The <code>data</code> directory contains the <code>build.json</code> (containing the build status of the directory updated after the image was pushed to its Docker Registry) and <code>build.log</code> (containing the logs from the secure build). The <code>git</code> directory contains the source code used for the build (cloned from git). Finally, the <code>root_ssh</code> directory contains any <code>ssh</code> material provided (if the user chose to use ssh) which is empty for us because we didn't enable ssh and provide ssh keys. This way no one can ssh into our secure build container. </p>
</div>
</li>
<li>
<p>What does this give me?</p>
<p>This gives you a way to see the collection of files used for your build at the time of the build and signed by the manifest private key which is secured in your secure build container. By retrieving the public key and verifying the signature of the package we <em>and auditors</em> can verify what was used for our secure image build. (Since the private key was generated in the secure build server we can trust it) This gives us verification of what was used in the build as well as the verification of the images themselves we get from <a href="https://docs.docker.com/engine/security/trust/content_trust/" target="_blank">Docker Content Trust</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The secure build server also generates the keys for Docker Content Trust and stores them safely to provide a secure root of trust.</p>
<p><em>Remember the secure build server is running as a Hyper Protect Virtual Server and thus inherits all of the security features and assurances of Hyper Protect Virtual Servers.</em></p>
</div>
</li>
</ol>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>Congratulations!!! <img alt="🎉" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f389.svg" title=":tada:" /> </p>
<p>You have securely built your application and are ready to deploy it into a Hyper Protect Virtual Server in the next section.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../create-server/" title="Create your HPVS Secure Build Server" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Create your HPVS Secure Build Server
              </div>
            </div>
          </a>
        
        
          <a href="../deploy-app/" title="Deploy your Securely Built Application as a Hyper Protect Virtual Server" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Deploy your Securely Built Application as a Hyper Protect Virtual Server
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>